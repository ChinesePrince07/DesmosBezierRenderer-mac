<!DOCTYPE html>
<html lang='en'>
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Desmos | Graphing Calculator</title>
      <link rel='icon' href='https://www.desmos.com/assets/img/apps/graphing/favicon.ico'>
      <script src='https://www.desmos.com/api/v1.8/calculator.js?apiKey={{ api_key }}'></script>
      <style>
         body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
         }
         #upload-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid #2464b4;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 250px;
         }
         #upload-panel h3 {
            margin: 0 0 10px 0;
            color: #2464b4;
            font-size: 14px;
         }
         #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            color: #666;
         }
         #drop-zone:hover, #drop-zone.dragover {
            border-color: #2464b4;
            background: #f0f7ff;
         }
         #drop-zone.dragover {
            transform: scale(1.02);
         }
         #file-input {
            display: none;
         }
         #upload-status {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
         }
         #upload-status.success {
            color: #28a745;
         }
         #upload-status.error {
            color: #dc3545;
         }
         #render-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background: #2464b4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
         }
         #render-btn:hover {
            background: #1a4a8a;
         }
         #render-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
         }
         #toggle-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2464b4;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 999;
            font-size: 12px;
            display: none;
         }
         #close-panel {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
            width: 24px;
            height: 24px;
         }
         #close-panel:hover {
            color: #333;
         }
         #upload-panel h3 {
            padding-right: 20px;
         }
         /* Mobile responsive styles */
         @media (max-width: 480px) {
            #upload-panel {
               bottom: 5px;
               right: 5px;
               left: 5px;
               max-width: none;
               padding: 12px;
            }
            #drop-zone {
               padding: 15px;
               font-size: 14px;
            }
            #render-btn {
               padding: 12px;
               font-size: 14px;
            }
            #toggle-panel {
               padding: 12px 16px;
               font-size: 14px;
            }
         }
      </style>
   </head>
   <body>
      <div id='calculator' style='width: 100%; height: 100%;'></div>

      <div id='upload-panel'>
         <button id='close-panel' title='Hide panel (Esc)'>&times;</button>
         <h3>Upload Image</h3>
         <div id='drop-zone'>
            Drop image(s) here<br>or click to browse
         </div>
         <input type='file' id='file-input' accept='image/*' multiple>
         <div id='upload-status'></div>
         <button id='render-btn'>Render Uploaded Image</button>
      </div>
      <button id='toggle-panel'>Show Upload</button>

      <script>
         // Upload functionality
         const dropZone = document.getElementById('drop-zone');
         const fileInput = document.getElementById('file-input');
         const uploadStatus = document.getElementById('upload-status');
         const renderBtn = document.getElementById('render-btn');
         const uploadPanel = document.getElementById('upload-panel');
         const togglePanel = document.getElementById('toggle-panel');
         const closePanel = document.getElementById('close-panel');
         let uploadedFrame = null;

         function hideUploadPanel() {
            uploadPanel.style.display = 'none';
            togglePanel.style.display = 'block';
         }

         function showUploadPanel() {
            uploadPanel.style.display = 'block';
            togglePanel.style.display = 'none';
         }

         closePanel.addEventListener('click', hideUploadPanel);

         dropZone.addEventListener('click', () => fileInput.click());

         dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
         });

         dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
         });

         dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
               uploadFiles(files);
            } else {
               showStatus('Please drop image file(s)', 'error');
            }
         });

         fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
               uploadFiles(Array.from(e.target.files));
            }
         });

         async function uploadFiles(files) {
            files.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

            showStatus(`Uploading ${files.length} file(s)...`, '');
            renderBtn.disabled = true;

            let uploaded = 0;
            let lastFrame = 0;

            for (let i = 0; i < files.length; i++) {
               const file = files[i];
               const frameNum = i + 1;

               const formData = new FormData();
               formData.append('file', file);
               formData.append('frame', frameNum);

               try {
                  const controller = new AbortController();
                  const timeoutId = setTimeout(() => controller.abort(), 60000);

                  const response = await fetch('/upload', {
                     method: 'POST',
                     body: formData,
                     signal: controller.signal
                  });
                  clearTimeout(timeoutId);
                  const data = await response.json();

                  if (data.success) {
                     uploaded++;
                     lastFrame = data.frame;
                     showStatus(`Uploaded ${uploaded}/${files.length}: ${file.name}`, '');
                  } else {
                     showStatus(`Failed: ${file.name} - ${data.error}`, 'error');
                  }
               } catch (err) {
                  showStatus(`Failed: ${file.name} - ${err.message}`, 'error');
               }
            }

            if (uploaded > 0) {
               showStatus(`Uploaded ${uploaded} frame(s)`, 'success');
               uploadedFrame = 1;
               totalUploadedFrames = uploaded;
               renderBtn.disabled = false;
               renderBtn.textContent = uploaded > 1 ? `Render ${uploaded} Frames` : 'Render Uploaded Image';
            }
         }

         let totalUploadedFrames = 0;

         function showStatus(msg, type) {
            uploadStatus.textContent = msg;
            uploadStatus.className = type;
         }

         renderBtn.addEventListener('click', () => {
            if (uploadedFrame !== null) {
               calculator.setExpression({ id: 'frame', latex: 'f=' + uploadedFrame });
            }
         });

         togglePanel.addEventListener('click', showUploadPanel);

         document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
               hideUploadPanel();
            }
         });

         // Desmos calculator functionality
         var elt = document.getElementById('calculator');
         var calculator = Desmos.GraphingCalculator(elt);

         var inner = elt.getElementsByClassName('dcg-graph-outer')[0];
         var defaultState;
         var hiddenGraph;
         var latex;

         function sleep(milliseconds) {
            return new Promise(r => setTimeout(r, milliseconds));
         }

         async function changeGraph(latex) {
            var default_expressions = hiddenGraph.expressions.list.slice();

            for (var expr of latex) {
               hiddenGraph.expressions.list.push({
                  color: expr.color,
                  id: expr.id,
                  latex: expr.latex,
                  type: "expression"
               })
            }

            calculator.setState( hiddenGraph, {'allowUndo': false} );
            hiddenGraph.expressions.list = default_expressions;

            if (latex.length < 3000) {
               await sleep(5000);
            }
         }

         calculator.updateSettings({
            showGrid: {{ show_grid|tojson }},
            showXAxis: {{ show_grid|tojson }},
            showYAxis: {{ show_grid|tojson }}
         });

         calculator.setMathBounds({
            left: 0,
            right: {{ width }},
            bottom: 0,
            top: {{ height }}
         });

         calculator.setExpression({ id: 'frame', latex: 'f=0', color: '#2464b4', sliderBounds: { step: 1, max: {{ total_frames }}, min: 0 } });
         calculator.setExpression({ id: 'lines', latex: 'L=0', color: '#2464b4', sliderBounds: { step: 1, min: 0 } });

         hiddenGraph = calculator.getState();

         const interval = setInterval(() => {
            const f = calculator.HelperExpression({ latex: 'f' });
            f.observe('numericValue', () => {
               f.unobserve('numericValue');
               if (Number.isNaN(f.numericValue) || f.numericValue <= 0) return;
               clearInterval(interval);
               setTimeout(() => renderFrame(--f.numericValue), 3000);
            });
         }, 500);

         defaultState = calculator.getState();
         defaultState.graph.showGrid = defaultState.graph.showXAxis = defaultState.graph.showYAxis = {{ show_grid|tojson }};

         var tmpState = calculator.getState();
         tmpState.expressions.list.push({type: 'text', id: 'info', text: 'Welcome to Desmos Bezier Renderer!\n\nVariables:\n  f = current frame\n  L = number of Bezier curves\n\nTo render: set f=1\n\nOr use the Upload panel (bottom right) to upload images directly!'});
         calculator.setState(tmpState);

         async function renderFrame(frame) {
            const requestData = (frame) => {
               return new Promise((resolve, reject) => {
                  const xhr = new XMLHttpRequest();
                  xhr.open('GET', `/?frame=${frame}`);
                  xhr.timeout = 60000; // 60 second timeout for mobile
                  xhr.ontimeout = () => reject(`frame: ${frame} request timed out.`);
                  xhr.onerror = () => reject(`frame: ${frame} network error.`);
                  xhr.send();
                  xhr.onload = () => {
                     try {
                        const response = JSON.parse(xhr.response);
                        if (response.result === null) {
                           reject(`frame: ${frame} could not be rendered.`);
                        } else {
                           resolve(response.result);
                        }
                     } catch (e) {
                        reject(`frame: ${frame} invalid response.`);
                     }
                  }
               });
            }

            try {
               var response = await requestData(frame);
               while (frame < {{ total_frames }} && response) {
                  hiddenGraph.expressions.list[0].latex = 'f=' + (frame + 1);
                  hiddenGraph.expressions.list[1].latex = 'L=' + response.length;

                  await changeGraph(response);

                  const params = {
                     mode: 'contain',
                     mathBounds: { left: 0, bottom: 0, right: {{ width }}, top: {{ height }} },
                     width: {{ screenshot_size|tojson }}[0] || window.screen.width,
                     height: {{ screenshot_size|tojson }}[1] || window.screen.height,
                     targetPixelRatio: 1,
                     format: {{ screenshot_format|tojson }}
                  }

                  function finishRender() {
                     return new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                           reject('Screenshot timed out');
                        }, 30000);
                        try {
                           calculator.asyncScreenshot(params, screenshot => {
                              clearTimeout(timeout);
                              handleScreenshot(screenshot, frame + 1);
                              resolve('render has finished');
                           });
                        } catch (e) {
                           clearTimeout(timeout);
                           reject(e);
                        }
                     });
                  }

                  await finishRender();

                  if (response.length >= 3000) {
                     await sleep(5000);
                  }

                  frame++;
                  response = await requestData(frame);
               }
            }
            catch (err) {
               console.log(err);
            }
         }

         const imgcont = document.createElement('a');
         document.body.appendChild(imgcont);

         async function handleScreenshot(screenshot, frame) {
            if (!{{ download_images|tojson }}) {
               return;
            }

            let screenshot_uri;
            if ( {{ screenshot_format|tojson }} === 'png' ) {
               screenshot_uri = screenshot;
            }
            else if ( {{ screenshot_format|tojson }} === 'svg' ) {
               const svg_b64 = window.btoa(screenshot);
               screenshot_uri = "data:image/svg+xml;base64," + svg_b64;
            }

            imgcont.href = screenshot_uri;
            imgcont.download = 'frame-' + String(frame).padStart(5, '0');
            imgcont.innerHTML = `<img src= ${screenshot_uri}>`;
            imgcont.click();
         }
      </script>
   </body>
</html>
